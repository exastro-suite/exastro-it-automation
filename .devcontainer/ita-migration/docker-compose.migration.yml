#   Copyright 2025 NEC Corporation
#
#   Licensed under the Apache License, Version 2.0 (the "License");
#   you may not use this file except in compliance with the License.
#   You may obtain a copy of the License at
#
#       http://www.apache.org/licenses/LICENSE-2.0
#
#   Unless required by applicable law or agreed to in writing, software
#   distributed under the License is distributed on an "AS IS" BASIS,
#   WITHOUT WARRANTIES OR CONDITIONS OF ANY KIND, either express or implied.
#   See the License for the specific language governing permissions and
#   limitations under the License.
version: '3.7'
services:
  ita-migration:
    command: echo "not execute migration"

  ita-migration-dev:
    user: 1000:1000
    build:
      dockerfile: ./ita_root/ita_migration/Dockerfile
      context: ../.
      args:
        - HTTP_PROXY=${HTTP_PROXY}
        - http_proxy=${HTTP_PROXY}
        - HTTPS_PROXY=${HTTPS_PROXY}
        - https_proxy=${HTTPS_PROXY}
      target: develop_build
      secrets:
        - host_certificate_file
    command: python3 /exastro/migration_main.py
    environment:
      - TZ=Asia/Tokyo
      - ENCRYPT_KEY=${ENCRYPT_KEY}
      - DB_HOST=${DB_HOST}
      - DB_PORT=${DB_PORT}
      - DB_DATABASE=${DB_DATABASE}
      - DB_USER=${DB_USER}
      - DB_PASSWORD=${DB_PASSWORD}
      - DB_ADMIN_USER=${DB_ADMIN_USER}
      - DB_ADMIN_PASSWORD=${DB_ADMIN_PASSWORD}
      - PLATFORM_API_HOST=platform-api
      - PLATFORM_API_PORT=8000
      - SYSTEM_ANSIBLE_EXECUTION_LIMIT=${SYSTEM_ANSIBLE_EXECUTION_LIMIT}
      - SYSTEM_ANSIBLE_EXECUTION_LIMIT_DESCRIPTION=${SYSTEM_ANSIBLE_EXECUTION_LIMIT_DESCRIPTION}
      - ORG_ANSIBLE_EXECUTION_LIMIT_DEFAULT=${ORG_ANSIBLE_EXECUTION_LIMIT_DEFAULT}
      - ORG_ANSIBLE_EXECUTION_LIMIT_MAX=${ORG_ANSIBLE_EXECUTION_LIMIT_MAX}
      - ORG_ANSIBLE_EXECUTION_LIMIT_DESCRIPTION=${ORG_ANSIBLE_EXECUTION_LIMIT_DESCRIPTION}
      - ORG_COMMON_UPLOAD_FILE_LIMIT_DESCRIPTION=${ORG_COMMON_UPLOAD_FILE_LIMIT_DESCRIPTION}
      - ORG_COMMON_UPLOAD_FILE_LIMIT_MAX=${ORG_COMMON_UPLOAD_FILE_LIMIT_MAX}
      - ORG_COMMON_UPLOAD_FILE_LIMIT_DEFAULT=${ORG_COMMON_UPLOAD_FILE_LIMIT_DEFAULT}
      - SYSTEM_MENU_EXPORT_IMPORT_BUFFER_SIZE=${SYSTEM_MENU_EXPORT_IMPORT_BUFFER_SIZE}
      - SYSTEM_MENU_EXPORT_IMPORT_BUFFER_SIZE_DESCRIPTION=${SYSTEM_MENU_EXPORT_IMPORT_BUFFER_SIZE_DESCRIPTION}
      - ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_DESCRIPTION=${ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_DESCRIPTION}
      - ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_MAX=${ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_MAX}
      - ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_DEFAULT=${ORG_MENU_EXPORT_IMPORT_BUFFER_SIZE_DEFAULT}
      - MONGO_OPTION_SSL=${MONGO_OPTION_SSL:-FALSE}
      - MONGO_SCHEME=${MONGO_SCHEME:-mongodb}
      - MONGO_HOST=${MONGO_HOST-ita-mongodb}
      - MONGO_PORT=${MONGO_PORT:-27017}
      - HTTP_PROXY=${HTTP_PROXY}
      - http_proxy=${HTTP_PROXY}
      - HTTPS_PROXY=${HTTPS_PROXY}
      - https_proxy=${HTTPS_PROXY}
      - NO_PROXY=localhost,127.0.0.1,ita-api-organization,ita-api-admin,ita-web-server,platform-api
      - no_proxy=localhost,127.0.0.1,ita-api-organization,ita-api-admin,ita-web-server,platform-api
      - SSL_CERT_FILE=/etc/ssl/certs/ca-certificates.crt
      - SSL_CERT_DIR=/etc/ssl/certs
      - NODE_EXTRA_CA_CERTS=/etc/ssl/certs/ca-certificates.crt
    volumes:
      - vol-ita-storage:/storage
      - ..:/workspace:cached
      - ../ita_root/common_libs:/workspace/ita_root/ita_migration/common_libs:cached
      - ../ita_root/messages:/workspace/ita_root/ita_migration/messages:cached
      - ../ita_root/ita_migration:/exastro:cached
      - ../ita_root/common_libs:/exastro/common_libs:cached
      - ../ita_root/messages:/exastro/messages:cached
      - ~/.netrc:/home/app_user/.netrc
      - ~/.gitconfig:/home/app_user/.gitconfig
      - ./ita-migration/.vscode/launch.json:/workspace/.vscode/launch.json
      - /usr/share/pki/ca-trust-source/anchors/UserRootCertificate.crt:/etc/ssl/certs/ca-certificates.crt
      - /mnt/mainte/talisman/.talismanrc:/mnt/mainte/talisman/.talismanrc
      - ~/.config/git/ignore:/home/app_user/.config/git/ignore
      - ${TALISMAN_HOME}:${TALISMAN_HOME}
      - ../.vscode_extensions/ita-migration/.vscode-server/extensions:/home/app_user/.vscode-server/extensions
      - ../.vscode_extensions/ita-migration/.vscode-server-insiders/extensions:/home/app_user/.vscode-server-insiders/extensions
      - /var/run/docker.sock:/var/run/docker.sock
    networks:
      - exastro
    depends_on:
      ita-mariadb:
        condition: service_healthy
      platform-migration-2:
        condition: service_completed_successfully
